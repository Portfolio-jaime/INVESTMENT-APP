# Global configuration
global:
  # Container registry for custom images
  imageRegistry: "trii-registry.azurecr.io"
  # Storage class for persistent volumes
  storageClass: "premium-ssd"
  # Domain for ingress
  domain: "trii.co"
  # Environment
  environment: "production"

# Prometheus Stack Configuration
prometheus:
  enabled: true

kube-prometheus-stack:
  # Prometheus Server Configuration
  prometheus:
    enabled: true
    prometheusSpec:
      # Resources
      resources:
        requests:
          memory: 2Gi
          cpu: 500m
        limits:
          memory: 4Gi
          cpu: 1000m
      
      # Storage
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: premium-ssd
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 50Gi
      
      # Retention
      retention: "30d"
      retentionSize: "45GB"
      
      # External labels
      externalLabels:
        cluster: trii-production
        environment: production
      
      # Service Monitor configuration
      serviceMonitorSelectorNilUsesHelmValues: false
      podMonitorSelectorNilUsesHelmValues: false
      ruleSelectorNilUsesHelmValues: false
      
      # Additional scrape configs
      additionalScrapeConfigs:
        - job_name: 'trii-services'
          kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names:
              - trii-platform
          relabel_configs:
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_service_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_service_name]
            action: replace
            target_label: kubernetes_name

  # AlertManager Configuration
  alertmanager:
    enabled: true
    alertmanagerSpec:
      # Resources
      resources:
        requests:
          memory: 256Mi
          cpu: 100m
        limits:
          memory: 512Mi
          cpu: 200m
      
      # Storage
      storage:
        volumeClaimTemplate:
          spec:
            storageClassName: premium-ssd
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 10Gi
      
      # Configuration
      configSecret: alertmanager-config
      
      # External URL
      externalUrl: https://alertmanager.trii.co

  # Grafana Configuration
  grafana:
    enabled: true
    
    # Admin credentials
    admin:
      existingSecret: grafana-admin-credentials
      userKey: admin-user
      passwordKey: admin-password
    
    # Resources
    resources:
      requests:
        memory: 512Mi
        cpu: 200m
      limits:
        memory: 1Gi
        cpu: 500m
    
    # Persistence
    persistence:
      enabled: true
      storageClassName: premium-ssd
      size: 10Gi
      accessModes:
        - ReadWriteOnce
    
    # Datasources
    sidecar:
      datasources:
        enabled: true
        defaultDatasourceEnabled: true
        searchNamespace: trii-monitoring
      dashboards:
        enabled: true
        searchNamespace: trii-monitoring
        folderAnnotation: grafana-dashboard-folder
        provider:
          allowUiUpdates: true
          disableDelete: false
          foldersFromFilesStructure: true
    
    # Additional datasources
    additionalDataSources:
      - name: Loki
        type: loki
        access: proxy
        url: http://loki.trii-monitoring.svc.cluster.local:3100
        isDefault: false
        editable: true
        jsonData:
          maxLines: 1000
      - name: Jaeger
        type: jaeger
        access: proxy
        url: http://jaeger-query.trii-monitoring.svc.cluster.local:16686
        isDefault: false
        editable: true
        jsonData:
          tracesToLogsV2:
            datasourceUid: loki
            tags: ['job', 'instance', 'pod', 'namespace']
    
    # Grafana configuration
    grafana.ini:
      server:
        root_url: https://grafana.trii.co
        serve_from_sub_path: false
      security:
        admin_user: admin
        cookie_secure: true
        cookie_samesite: strict
      auth:
        disable_login_form: false
        disable_signout_menu: false
      auth.anonymous:
        enabled: false
      analytics:
        reporting_enabled: false
        check_for_updates: false
      dashboards:
        default_home_dashboard_path: /var/lib/grafana/dashboards/trii-overview.json
      alerting:
        enabled: true
        execute_alerts: true
      unified_alerting:
        enabled: true
      smtp:
        enabled: true
        host: smtp.gmail.com:587
        user: alerts@trii.co
        password: """$__file{/etc/secrets/smtp-password}"""
        from_address: alerts@trii.co
        from_name: TRII Monitoring
    
    # Plugins
    plugins:
      - grafana-piechart-panel
      - grafana-worldmap-panel
      - grafana-clock-panel
      - redis-datasource
      - postgres-datasource
      - grafana-polystat-panel
      - vonage-status-panel
    
    # Dashboard providers
    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
        - name: 'trii-business'
          orgId: 1
          folder: 'TRII Business Intelligence'
          type: file
          disableDeletion: true
          editable: true
          options:
            path: /var/lib/grafana/dashboards/business
        - name: 'trii-technical'
          orgId: 1
          folder: 'TRII Technical'
          type: file
          disableDeletion: true
          editable: true
          options:
            path: /var/lib/grafana/dashboards/technical
        - name: 'kubernetes'
          orgId: 1
          folder: 'Kubernetes'
          type: file
          disableDeletion: false
          editable: false
          options:
            path: /var/lib/grafana/dashboards/k8s
    
    # Ingress
    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
      hosts:
        - grafana.trii.co
      tls:
        - secretName: grafana-tls
          hosts:
            - grafana.trii.co

  # Node Exporter
  nodeExporter:
    enabled: true

  # Kube State Metrics
  kubeStateMetrics:
    enabled: true

# Loki Stack Configuration  
loki:
  enabled: true

loki-stack:
  loki:
    enabled: true
    persistence:
      enabled: true
      storageClassName: premium-ssd
      size: 20Gi
    config:
      auth_enabled: false
      server:
        http_listen_port: 3100
        grpc_listen_port: 9096
      common:
        path_prefix: /loki
        storage:
          filesystem:
            chunks_directory: /loki/chunks
            rules_directory: /loki/rules
        replication_factor: 1
        ring:
          kvstore:
            store: inmemory
      schema_config:
        configs:
          - from: 2020-10-24
            store: boltdb-shipper
            object_store: filesystem
            schema: v11
            index:
              prefix: index_
              period: 24h
      storage_config:
        boltdb_shipper:
          active_index_directory: /loki/boltdb-shipper-active
          cache_location: /loki/boltdb-shipper-cache
          shared_store: filesystem
        filesystem:
          directory: /loki/chunks
      limits_config:
        retention_period: 168h  # 7 days
        ingestion_rate_mb: 16
        ingestion_burst_size_mb: 32
        max_query_series: 100000

  promtail:
    enabled: true
    config:
      clients:
        - url: http://loki:3100/loki/api/v1/push
      scrape_configs:
        - job_name: kubernetes-pods
          kubernetes_sd_configs:
            - role: pod
          pipeline_stages:
            - cri: {}
          relabel_configs:
            - source_labels:
                - __meta_kubernetes_pod_controller_name
              regex: ([0-9a-z-.]+?)(-[0-9a-f]{8,10})?
              action: replace
              target_label: __tmp_controller_name
            - source_labels:
                - __meta_kubernetes_pod_label_app_kubernetes_io_name
                - __meta_kubernetes_pod_label_app
                - __tmp_controller_name
                - __meta_kubernetes_pod_name
              regex: ^;*([^;]+)(;.*)?$
              action: replace
              target_label: app
            - source_labels:
                - __meta_kubernetes_pod_label_app_kubernetes_io_instance
                - __meta_kubernetes_pod_label_release
              regex: ^;*([^;]+)(;.*)?$
              action: replace
              target_label: instance
            - source_labels:
                - __meta_kubernetes_pod_uid
                - __meta_kubernetes_pod_container_name
              regex: (.*)
              action: replace
              target_label: __path__
              replacement: /var/log/pods/*$1/*.log

# Jaeger Configuration
jaeger:
  enabled: true

jaeger:
  provisionDataStore:
    cassandra: false
    elasticsearch: false
    memory: true
  allInOne:
    enabled: true
    resources:
      requests:
        memory: 512Mi
        cpu: 200m
      limits:
        memory: 1Gi
        cpu: 500m
  agent:
    enabled: false
  collector:
    enabled: false
  query:
    enabled: false

# ServiceMonitors for TRII services
serviceMonitors:
  enabled: true
  services:
    - name: market-data-service
      selector:
        matchLabels:
          app.kubernetes.io/name: market-data-service
      endpoints:
      - port: http
        path: /metrics
        interval: 30s
    - name: ml-prediction-service
      selector:
        matchLabels:
          app.kubernetes.io/name: ml-prediction-service
      endpoints:
      - port: http
        path: /metrics
        interval: 30s
    - name: portfolio-manager-service
      selector:
        matchLabels:
          app.kubernetes.io/name: portfolio-manager-service
      endpoints:
      - port: http
        path: /metrics
        interval: 30s
    - name: api-gateway
      selector:
        matchLabels:
          app.kubernetes.io/name: api-gateway
      endpoints:
      - port: http
        path: /metrics
        interval: 30s

# Ingress configuration for monitoring services
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: monitoring-basic-auth
    nginx.ingress.kubernetes.io/auth-realm: "TRII Monitoring - Authentication Required"
  hosts:
    prometheus:
      host: prometheus.trii.co
      service: kube-prometheus-stack-prometheus
      port: 9090
    alertmanager:
      host: alertmanager.trii.co
      service: kube-prometheus-stack-alertmanager
      port: 9093
  tls:
    - secretName: monitoring-tls
      hosts:
        - prometheus.trii.co
        - alertmanager.trii.co