apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-rbac-cm
    app.kubernetes.io/part-of: argocd
data:
  # ArgoCD RBAC policy CSV
  policy.csv: |
    # Built-in policy groups
    g, argocd-admin, role:admin
    g, argocd-devops, role:admin
    g, argocd-readonly, role:readonly

    # Application permissions
    p, role:developer, applications, get, */*, allow
    p, role:developer, applications, sync, */*, allow
    p, role:developer, applications, update, */*, allow
    p, role:developer, applications, delete, trii-dev/*, deny
    p, role:developer, applications, delete, trii-staging/*, deny

    # Project permissions
    p, role:developer, projects, get, default, allow
    p, role:developer, projects, get, trii-platform, allow

    # Cluster permissions (limited)
    p, role:developer, clusters, get, https://kubernetes.default.svc, allow

    # Logs permissions
    p, role:developer, logs, get, */*, allow

    # Exec permissions (only for development)
    p, role:developer, exec, create, trii-dev/*, allow

    # Assign users to roles
    g, alice@trii-platform.com, role:admin
    g, bob@trii-platform.com, role:developer
    g, charlie@trii-platform.com, role:readonly

  # Default role for users
  policy.default: role:readonly

  # RBAC scopes (optional)
  scopes: '[groups, email]'

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-cm
    app.kubernetes.io/part-of: argocd
data:
  # ArgoCD configuration
  accounts.alice: apiKey, login
  accounts.bob: apiKey, login
  accounts.charlie: apiKey, login

  # Resource customizations
  resource.customizations: |
    networking.k8s.io/Ingress:
      health.lua: |
        hs = {}
        hs.status = "Healthy"
        return hs
    cert-manager.io/Certificate:
      health.lua: |
        hs = {}
        if obj.status ~= nil then
          if obj.status.conditions ~= nil then
            for i, condition in ipairs(obj.status.conditions) do
              if condition.type == "Ready" and condition.status == "True" then
                hs.status = "Healthy"
                return hs
              end
            end
          end
        end
        hs.status = "Progressing"
        return hs

  # Repository credentials (if using private repos)
  # repository.credentials: |
  #   - url: https://github.com/trii-platform
  #     usernameSecret:
  #       name: github-creds
  #       key: username
  #     passwordSecret:
  #       name: github-creds
  #       key: password

  # Application instance label key
  application.instance.label.key: argocd

  # Dex configuration (for SSO)
  # dex.config: |
  #   issuer: https://argocd.trii-platform.com/api/dex
  #   web:
  #     http: 0.0.0.0:5556
  #   storage:
  #     type: kubernetes
  #     config:
  #       inCluster: true
  #   connectors:
  #   - type: github
  #     id: github
  #     name: GitHub
  #     config:
  #       clientId: $dex.github.clientId
  #       clientSecret: $dex.github.clientSecret
  #       orgs:
  #       - name: trii-platform

---
# Secret template for GitHub credentials (replace with actual values)
# apiVersion: v1
# kind: Secret
# metadata:
#   name: github-creds
#   namespace: argocd
#   labels:
#     argocd.argoproj.io/secret-type: repo-creds
# type: Opaque
# stringData:
#   username: your-github-username
#   password: your-github-token
